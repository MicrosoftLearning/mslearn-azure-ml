name: Update Changelog on PR Merge

on:
  pull_request:
    types: [closed]
    branches: [main]

jobs:
  update-changelog:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      pull-requests: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Generate changelog entry with GitHub Copilot
        id: generate-entry
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            // Get PR information
            const pr = context.payload.pull_request;
            
            if (!pr) {
              throw new Error('Pull request data not available in context');
            }
            
            const prNumber = pr.number;
            const prTitle = pr.title;
            const prBody = pr.body || '';
            const prAuthor = pr.user.login;
            const mergedAt = pr.merged_at;
            const prUrl = pr.html_url;
            
            console.log('Processing PR #' + prNumber + ': ' + prTitle);
            
            // Get list of changed files
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });
            
            const changedFiles = files.map(file => ({
              filename: file.filename,
              additions: file.additions,
              deletions: file.deletions,
              status: file.status,
              changes: file.changes
            }));
            
            // Build file changes summary
            const filesSummary = changedFiles.map(f => 
              f.filename + ' (' + f.status + ', +' + f.additions + '/-' + f.deletions + ')'
            ).join(', ');
            
            // Prepare context for GitHub Copilot
            const prompt = 'Create a concise changelog entry for this pull request:\n\n' +
              'Title: ' + prTitle + '\n' +
              'Description: ' + prBody + '\n' +
              'Files changed: ' + filesSummary + '\n\n' +
              'Generate a professional, past-tense summary (max 2 sentences) focusing on what was changed and its impact.';

            // Use GitHub Copilot Chat API (Note: This API may not be available in all Copilot plans)
            let summary;
            try {
              console.log('Attempting to use GitHub Copilot API...');
              const copilotResponse = await github.request('POST /copilot/chat/completions', {
                messages: [
                  {
                    role: 'system',
                    content: 'You are a technical writer creating concise changelog entries. Focus on user impact and key changes.'
                  },
                  {
                    role: 'user',
                    content: prompt
                  }
                ],
                model: 'gpt-4o',
                max_tokens: 100,
                temperature: 0.3
              });
              
              summary = copilotResponse.data.choices[0].message.content.trim();
              console.log('Successfully generated summary with Copilot API');
              
            } catch (error) {
              // Fallback to rule-based summary if Copilot API fails
              console.log('Copilot API failed, using fallback summary. Error:', error.message);
              console.log('This is normal if GitHub Copilot Chat API is not available in your plan.');
              
              // Simple rule-based summary generation
              summary = prTitle;
              
              // Add context based on file types
              const fileTypes = [...new Set(changedFiles.map(f => {
                const ext = f.filename.split('.').pop();
                if (ext === 'ipynb') return 'notebooks';
                if (ext === 'md') return 'documentation';
                if (ext === 'py') return 'Python scripts';
                if (ext === 'yml' || ext === 'yaml') return 'configuration';
                return 'files';
              }))];
              
              if (fileTypes.length > 0) {
                summary += ' Updated ' + fileTypes.join(', ') + '.';
              }
            }
            
            // Format date
            const date = new Date(mergedAt).toISOString().split('T')[0];
            
            // Create changelog entry
            const changelogEntry = '## ' + date + ' - PR #' + prNumber + '\n\n' +
              summary + '\n\n' +
              '*Merged by: ' + prAuthor + '* | [View PR](' + prUrl + ')\n\n';
            
            // Read existing changelog or create new one
            const changelogPath = 'CHANGELOG.md';
            let existingContent = '';
            
            try {
              existingContent = fs.readFileSync(changelogPath, 'utf8');
            } catch (error) {
              existingContent = '# Changelog\n\nAll notable changes to this project will be documented in this file.\n\n';
            }
            
            // Insert new entry after the header
            const lines = existingContent.split('\n');
            const headerEndIndex = lines.findIndex(line => line.startsWith('# Changelog')) + 3;
            
            lines.splice(headerEndIndex, 0, changelogEntry);
            const newContent = lines.join('\n');
            
            // Write updated changelog
            fs.writeFileSync(changelogPath, newContent);
            
            return {
              entry: changelogEntry,
              summary: summary
            };
      
      - name: Commit and push changelog
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add CHANGELOG.md
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update changelog for PR #${{ github.event.pull_request.number }}"
            git push
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}